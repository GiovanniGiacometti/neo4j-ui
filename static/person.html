<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="static/css.css">
    <title>Neo4j ContactTracing</title>
</head>

<body>
<div id="graph">
</div>
<div role="navigation" class="navbar navbar-default navbar-static-top">
    <div class="container">
        <div class="row">
            
            <div class="navbar-header col-sm-6 col-md-6">
                <div class="navbar-brand">
                    <p><a href="/homepage">Neo4j ContactTracing </a></p>
                </div>
            </div>
        </div>
    </div>
</div>



<div class="row">
            
    <div class="navbar-header col-sm-6 col-md-6">
        <div class="navbar-brand">
            <h3 id="person"></h3>
            
            
        </div>
    </div>
</div>

<div class="row row_internal">
    <h3>COVID TEST</h3>
    <div class="col-sm-6 col-md-6">
        <ul class="nav navbar-nav">
            <li>
                <form role="search" class="navbar-form" id="search">
                    <button class="btn btn-default"id="insertcovidtest_button" type="button">Insert Covid Test</button>
                    
                
                </form>
            </li>
        </ul>
    </div>
    
    <div id = "hiddendiv_covidtest" class="col-sm-6 col-md-6">
        <form role="search" class="navbar-form" id="search">
            <div class="form-group">
                <input type="text" value="" placeholder="Date (yyyy-mm-dd)" class="form-control" id="date_input">
            </div>
            <div class="form-group">
                <input type="text" value="" placeholder="Type" class="form-control" id="type_input">
            </div>
            <div class="form-group">
                <input type="text" value="" placeholder="Result" class="form-control" id="result_input">
            </div>
            
            <button class="btn btn-default"id="covid_sendtodb_button" type="button">Insert Covid Test</button>
        </form>
    </div>

    <div class="col-md-7">

        <div class="panel panel-default">

            <div class="row">
                <div class="col-md-8 col-sm-8">
                    
                    <table id="results" class="table table-striped table-hover">
                        <thead>
                        <tr>
                            <th>ID</th>
                            <th>DATE</th>
                            <th>TYPE</th>
                            <th>RESULT</th>
                        </tr>
                        </thead>
                        <tbody id="tbodytest">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <h3>VACCINE</h3>
    <div class="col-sm-6 col-md-6">
        <ul class="nav navbar-nav">
            <li>
                <form role="search" class="navbar-form" id="search">
                    <button class="btn btn-default"id="insertvaccine_button" type="button">Insert Vaccine</button>
                </form>
            </li>
        </ul>
    </div>
    <div id = "hiddendiv_vaccine" class="col-sm-6 col-md-6">
        <form role="search" class="navbar-form" id="search">
            <div class="form-group">
                <input type="text" size="25" value="" placeholder="First Dose Date (yyyy-mm-dd)" class="form-control" id="first_date_input">
            </div>
            <div class="form-group">
                <input type="text" size="25" value="" placeholder="Second Dose Date (yyyy-mm-dd)" class="form-control" id="second_date_input">
            </div>

            <div class="form-group">
                <select placeholder="Type" class="form-control" id="type_vaccine_select">
                        <option value="Pfizer">Pfizer</option>
                        <option value="Moderna">Moderna</option>
                        <option value="Astrazeneca">Astrazeneca</option>
                        <option value="Johnson&Johnson">Johnson&Johnson</option>
                </select>
            </div>
            
            <button class="btn btn-default"id="vaccine_sendtodb_button" type="button">Insert Vaccine</button>
        </form>
    </div>
    <div class="col-md-7">

        <div class="panel panel-default">

            <div class="row">
                <div class="col-md-8 col-sm-8">
                    
                    <table id="results" class="table table-striped table-hover">
                        <thead>
                        <tr>
                            <th>ID</th>
                            <th>TYPE</th>
                            <th>FIRST DOSE DATE</th>
                            <th>SECOND DOSE DATE</th>
                        </tr>
                        </thead>
                        <tbody id="tbodyvaccine">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        

        <h3>CONTACTS</h3>
        <ul class="nav navbar-nav">
            <li>
                <form role="search" class="navbar-form">
                    <button class="btn btn-default"id="insertrelationship_button" type="button">Insert Relationship</button>
                </form>
            </li>
        </ul>
        <div id = "hiddendiv_relationship" class="col-sm-6 col-md-6">
            <form role="search" class="navbar-form">
                <div class="form-group">
                    <input type="text" value="" placeholder="Taxcode" class="form-control" id="taxcode_input">
                </div>
                <div class="form-group">
                    <input size="20" type="text" value="" placeholder="Date (yyyy-mm-dd)" class="form-control" id="date_rel_input">
                </div>
                <div class="form-group">
                    <input type="text" value="" placeholder="Place" class="form-control" id="place_rel_input">
                </div>
                <div class="form-group">
                    <select placeholder="Type" class="form-control" id="type_select">
                            <option value="family">Family contact</option>
                            <option value="event">Event contact</option>
                            <option value="app">App contact</option>
                    </select>
                </div>
                
                
                <button class="btn btn-default"id="relationship_sendtodb_button" type="button">Insert Relationship</button>
            </form>
        </div>

    <div class="col-md-7">

        <div class="panel panel-default">

            <div class="row">
                <div class="col-md-8 col-sm-8">
                    
                    <table id="results" class="table table-striped table-hover">
                        <thead>
                        <tr>
                            <th>NAME</th>
                            <th>SURNAME</th>
                            <th>RELATIONSHIP TYPE</th>
                            <th>DATE</th>
                            <th>PLACE</th>
                        </tr>
                        </thead>
                        <tbody id="tbodycontacts">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    </div>
</div>
<style type="text/css">
    a {padding:5px}
    .row{
        padding:10px
    }
    .row_internal{
        margin:10px
    }
    
</style>
</body>
</html>




<script type="text/javascript" src="//code.jquery.com/jquery-1.11.0.min.js"></script>
<script src="https://d3js.org/d3.v3.min.js" type="text/javascript"></script>
<script type="text/javascript">
    $(function () {
        
        const urlSearchParams = new URLSearchParams(window.location.search);
        params = Object.fromEntries(urlSearchParams.entries())
        p = $("#person").html(params["name"] +" " + params["surname"])

        $("#place_rel_input").hide()
        $("#date_rel_input").hide()
        $("#hiddendiv_vaccine").hide()
        $("#hiddendiv_covidtest").hide()
        $("#hiddendiv_relationship").hide()

        $("#insertrelationship_button").on("click", function(){
                $("#hiddendiv_relationship").toggle()
            });
        
        $("#relationship_sendtodb_button").on("click", function(){
                createRelationship()
            });
        
        $("#vaccine_sendtodb_button").on("click", function(){
                createVaccine()
            });
        $("#covid_sendtodb_button").on("click", function(){
                createCovidTest()
            });
        $("#insertcovidtest_button").on("click", function(){
                $("#hiddendiv_covidtest").toggle()
            });
        $("#insertvaccine_button").on("click", function(){
                $("#hiddendiv_vaccine").toggle()
            });

        $('#type_select').on('change', function() {
                new_value = this.value
                if (new_value == "app"){
                    $("#date_rel_input").show()
                    $("#place_rel_input").hide() 
                }
                else if (new_value == "event"){
                    $("#date_rel_input").show()
                    $("#place_rel_input").show()
                }
                else{
                    $("#date_rel_input").hide()
                    $("#place_rel_input").hide() 
                }
            });

        $('#type_vaccine_select').on('change', function() {
                new_value = this.value
                if (new_value == "Johnson&Johnson"){
                    $("#second_date_input").hide()
                }
                else{
                    $("#second_date_input").show() 
                }
            });

        
        

        function createButtons(id, what){
            
            var input = $('<input type="button" value="Delete" class="btn btn-default" id="delete_' + what+ id + '"/>');

            input.appendTo($("#" + what + id));
            
            input.on("click", function(){
                if(what == "covidtest_")
                    deleteCovidTest(id)
                else if(what=="vaccine_")
                    deleteVaccine(id)
                else 
                    deleteContacts(id)
            });
        }

        function deleteContacts(taxcode2){
            
            $.get("/delete-contact?taxcode1=" + encodeURIComponent(params["taxcode"]) +"&taxcode2=" + encodeURIComponent(taxcode2),
                    function (data) {
                        showContacts(params["taxcode"])
                    })
        }
        
        function deleteVaccine(id){
            $.get("/delete-vaccine?id=" + encodeURIComponent(id),
                    function (data) {
                        showVaccine(params["taxcode"])
                    })
        }

        function deleteCovidTest(id){
            $.get("/delete-covidtest?id=" + encodeURIComponent(id),
                    function (data) {
                        showTests(params["taxcode"])
                    })
        }

        function showVaccine(taxcode) {
            $.get("/vaccine?taxcode=" + encodeURIComponent(taxcode),
                    function (data) {
                        const tbody = $("#tbodyvaccine").empty();
                        data.nodes.forEach(function (vaccine){
                        s = vaccine.second_dose_date=="None" ? "" : vaccine.second_dose_date
                        $("<tr id= 'vaccine_" + vaccine.id + "'><td>" + vaccine.id
                            + "</td><td>" + vaccine.type
                            + "</td><td>" + vaccine.first_dose_date
                            + "</td><td>" + s
                            + "</td></tr>"
                        ).appendTo(tbody)

                        createButtons(vaccine.id,"vaccine_")
                }, "json");
        })}

        function showContacts(taxcode) {
            $.get("/contacts?taxcode=" + encodeURIComponent(taxcode),
                    function (data) {
                        const tbody = $("#tbodycontacts").empty();
                        data.relationships.forEach(function ( rel, i){
                        date = rel.hasOwnProperty("date") ? rel.date : "" 
                        place = rel.hasOwnProperty("place") ? rel.place : ""

                        $("<tr id= 'contacts_" + rel.taxcode + "'><td>" 
                                              + rel.person_name
                                + "</td><td>" + rel.person_surname
                                + "</td><td>" + rel.rel_type
                                + "</td><td>" + date 
                                + "</td><td>" + place
                                + "</td></tr>"
                        ).appendTo(tbody)

                        createButtons(rel.taxcode,"contacts_")
                }, "json");
        })}

        function showTests(taxcode) {
            $.get("/covid-test?taxcode=" + encodeURIComponent(taxcode),
                    function (data) {
                        const tbody = $("#tbodytest").empty();
                        data.nodes.forEach(function ( covidTest){
                        $("<tr id= 'covidtest_" + covidTest.id + "'><td>" + covidTest.id
                                + "</td><td>" + covidTest.date
                                + "</td><td>" + covidTest.type
                                + "</td><td>" + covidTest.result
                                + "</td></tr>"
                        ).appendTo(tbody)

                        createButtons(covidTest.id,"covidtest_")
                }, "json");
        })}
        
        function createCovidTest(){
            const date = $("#date_input").val()
            const type = $("#type_input").val()
            const result = $("#result_input").val()
            
            $.get("/create-covid-test?date=" + encodeURIComponent(date) + "&type=" + encodeURIComponent(type) +
                        "&result=" + encodeURIComponent(result) + "&taxcode=" + encodeURIComponent(params["taxcode"]),
                    function (data) {
                            $("#date_input").val()
                        $("#type_input").val()
                        $("#result_input").val()
                        showTests(params["taxcode"])
                    })
        }
        
        function createVaccine(){
            const first_dose_date = $("#first_date_input").val()
            const type = $( "#type_vaccine_select" ).val();
            endpoint = "/create-vaccine?first_date=" + encodeURIComponent(first_dose_date) +
                                "&type=" + encodeURIComponent(type) + 
                                "&taxcode=" + encodeURIComponent(params["taxcode"])

            if (type != "Johnson&Johnson") {
                const second_dose_date = $("#second_date_input").val()
                endpoint += "&second_date=" + encodeURIComponent(second_dose_date)
            }              
            
            $.get(endpoint,
                    function (data) {
                        $("#first_date_input").val("")
                        $("#second_date_input").val("")
                        $("#type_vaccine_input").val("")
                        showVaccine(params["taxcode"])
                    })
        }

        function createRelationship(){
            const type = $( "#type_select" ).val();
            const inserted_taxcode = $("#taxcode_input").val()
            endpoint = "/create-relationship?first_taxcode=" + encodeURIComponent(params["taxcode"]) +
                        "&second_taxcode=" + encodeURIComponent(inserted_taxcode) + 
                        "&type=" + encodeURIComponent(type)
            
            if (type == "app"){
                const inserted_date = $("#date_rel_input").val()
                endpoint += "&date=" + encodeURIComponent(inserted_date)
            }
            else if (type == "event"){
                const inserted_date = $("#date_rel_input").val()
                const inserted_place = $("#place_rel_input").val()
                endpoint += "&date=" + encodeURIComponent(inserted_date) + 
                            "&place=" + encodeURIComponent(inserted_place)
            }
            $.get(endpoint,
                    function (data) {
                        $("#taxcode_input").val("")
                        $("#date_event_input").val("")
                        $("#date_event_input").val("")
                        showContacts(params["taxcode"])
                    })
        }

        showTests(params["taxcode"])
        showVaccine(params["taxcode"])
        showContacts(params["taxcode"])




    });
</script>